name: Public Release - MacOS

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-libraries:
    name: Libraries
    runs-on: macos-latest
    env:
      REPO_NAME: ${{ github.event.repository.name }}

    steps:
      - name: Clone.
        uses: actions/checkout@v6
        with:
          submodules: recursive
          path: ${{ env.REPO_NAME }}

      - name: First set up.
        run: |
          sudo chown -R `whoami`:admin /usr/local/share
          brew update
          brew upgrade || true
          brew install automake meson nasm ninja pkg-config
          brew install icoutils create-dmg
          sudo mdutil -a -i off
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Build Libraries.
        run: |
          cd $REPO_NAME
          ./Telegram/build/prepare/mac.sh silent

      - name: Free up some disk space.
        run: |
          cd Libraries
          find . -iname "*.dir" -exec rm -rf {} \; || true

      - name: Cache Libraries.
        uses: actions/cache@v4
        with:
          path: |
            ./Libraries
            ./ThirdParty
          key: mac-libraries-${{ hashFiles('tdesktop/Telegram/build/prepare/prepare.py') }}

  macos-build:
    environment: Release
    needs: build-libraries
    name: Telegram (${{ matrix.arch }})
    runs-on: macos-latest

    strategy:
      matrix:
        include:
          - arch: arm64
          - arch: x86_64

    env:
      UPLOAD_ARTIFACT: "true"
      ONLY_CACHE: "false"
      ARTIFACT_NAME: "PTelegram_"
      REPO_NAME: ${{ github.event.repository.name }}
      CP_ARCH: ${{ matrix.arch }}

    steps:
      - name: Clone.
        uses: actions/checkout@v6
        with:
          submodules: recursive
          path: ${{ env.REPO_NAME }}

      - name: First set up.
        run: |
          sudo chown -R `whoami`:admin /usr/local/share

          brew update
          brew upgrade || true
          brew install automake meson nasm ninja pkg-config

          brew install icoutils create-dmg

          # Disable spotlight.
          sudo mdutil -a -i off

          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Restore Libraries Cache.
        uses: actions/cache@v4
        with:
          path: |
            ./Libraries
            ./ThirdParty
          key: mac-libraries-${{ hashFiles('tdesktop/Telegram/build/prepare/prepare.py') }}

      - name: Try to restore previous build from cache.
        if: always()
        id: cache_restore
        uses: actions/cache@v4
        with:
          path: ${{ env.REPO_NAME }}/out/Release/artifact
          key: mac-${{ matrix.arch }}-${{ github.sha }}
          restore-keys: |
            mac-${{ matrix.arch }}-${{ github.sha }}

      - name: Telegram Desktop build (${{ matrix.arch }}).
        if: steps.cache_restore.outputs.cache-hit != 'true'
        env:
          RSA_PRIVATE: ${{ secrets.RSA_PRIVATE }}
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          cd $REPO_NAME/Telegram/build

          python3 release_build.py mac

      - name: Check build result.
        if: steps.cache_restore.outputs.cache-hit != 'true'
        run: |
          filePath="$REPO_NAME/out/Release/deploy"
          if test -d "$filePath"; then
            echo "${{ matrix.arch }} build successfully done! :)"

            ls $filePath
          else
            echo "Build error, output file does not exist."
            exit 1
          fi

      - name: Move artifact.
        if: steps.cache_restore.outputs.cache-hit != 'true'
        run: |
          cd $REPO_NAME/out/Release/deploy
          mkdir -p ../artifact
          mv * ../artifact || true

      - name: Cache build artifacts for reuse.
        if: steps.cache_restore.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ${{ env.REPO_NAME }}/out/Release/artifact
          key: mac-${{ matrix.arch }}-${{ github.sha }}

      - uses: actions/upload-artifact@v6
        if: env.UPLOAD_ARTIFACT == 'true'
        name: Upload ${{ matrix.arch }} update files.
        with:
          name: ${{ env.ARTIFACT_NAME }}${{ matrix.arch }}_tg
          path: ${{ env.REPO_NAME }}/out/Release/artifact/t*macupd*

      - uses: actions/upload-artifact@v6
        if: env.UPLOAD_ARTIFACT == 'true'
        name: Upload ${{ matrix.arch }} app bundle.
        with:
          name: ${{ env.ARTIFACT_NAME }}${{ matrix.arch }}_app
          path: ${{ env.REPO_NAME }}/out/Release/artifact/*.zip

      - uses: actions/upload-artifact@v6
        name: Upload ${{ matrix.arch }} symbols artifact.
        if: false
        with:
          name: symbols_${{ matrix.arch }}
          path: ${{ env.REPO_NAME }}/out/Dropbox/Telegram/symbols/*

  macos-combine:
    environment: Release
    needs: macos-build
    name: Telegram (Universal)
    runs-on: macos-latest

    env:
      UPLOAD_ARTIFACT: "true"
      ARTIFACT_NAME: "PTelegram_"
      REPO_NAME: ${{ github.event.repository.name }}

    steps:
      - name: Clone.
        uses: actions/checkout@v5
        with:
          submodules: recursive
          path: ${{ env.REPO_NAME }}

      - name: First set up.
        run: |
          sudo chown -R `whoami`:admin /usr/local/share

          brew update
          brew upgrade || true
          brew install icoutils create-dmg

          # Disable spotlight.
          sudo mdutil -a -i off

          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Create work directory.
        run: |
          mkdir -p combine_work

      - name: Download ARM64 artifacts.
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}arm64_app
          path: combine_work

      - name: Download x86_64 artifacts.
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}x86_64_app
          path: combine_work

      - name: Extract architecture-specific bundles.
        run: |
          cd combine_work
          ls -la
          
          # Extract ARM64 bundle
          unzip -q Telegram.arm64.app.zip 2>/dev/null || true
          
          # Rename extracted ARM64 app if needed
          if [ -d "Telegram.app" ]; then
            mv Telegram.app Telegram.arm64.app
          fi
          
          # Extract x86_64 bundle
          unzip -q Telegram.x86_64.app.zip 2>/dev/null || true
          
          # Rename extracted x86_64 app if needed
          if [ -d "Telegram.app" ]; then
            mv Telegram.app Telegram.x86_64.app
          fi
          
          # Verify both bundles exist
          if [ ! -d "Telegram.arm64.app" ] || [ ! -d "Telegram.x86_64.app" ]; then
            echo "ERROR: Missing one or both architecture bundles"
            ls -la
            exit 1
          fi
          
          ls -la

      - name: Combine architectures.
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          cd combine_work
          ${{ github.workspace }}/${{ env.REPO_NAME }}/Telegram/build/build_mac_release.sh .

      - name: Create output directory.
        run: |
          mkdir -p output
          cd combine_work
          
          # Copy universal app zip
          if [ -f "Telegram.app.zip" ]; then
            cp Telegram.app.zip ../output/
          fi
          
          # Copy DMG
          if [ -f "tsetup.latest.dmg" ]; then
            cp tsetup.latest.dmg ../output/
          fi
          
          ls -la ../output

      - uses: actions/upload-artifact@v6
        if: env.UPLOAD_ARTIFACT == 'true'
        name: Upload universal app.
        with:
          name: ${{ env.ARTIFACT_NAME }}_universal_app
          path: output/Telegram.app.zip

      - uses: actions/upload-artifact@v6
        if: env.UPLOAD_ARTIFACT == 'true'
        name: Upload universal DMG.
        with:
          name: telegram-dmg
          path: output/tsetup.latest.dmg
